# 架构设计文档

## 概述

Pharos Vault 是一个模块化的收益保险库系统，遵循 ERC4626 标准，旨在为用户提供一站式的多元化收益捕获方案。

## 核心设计理念

### 1. 可组合性 (Composability)
- **ERC4626 标准**: 完全兼容，可与其他 DeFi 协议无缝集成
- **策略插件化**: 策略可独立开发、部署和升级
- **接口标准化**: 所有策略实现统一的 IStrategy 接口

### 2. 安全性 (Security)
- **分层权限**: Owner / Keeper / User 三级权限体系
- **紧急机制**: 支持暂停、紧急撤回等保护措施
- **重入保护**: 关键函数使用 ReentrancyGuard

### 3. 透明度 (Transparency)
- **实时资产追踪**: `totalAssets()` 返回准确的总资产
- **收益归因**: 跟踪每个策略的收益和亏损
- **事件日志**: 所有重要操作都有事件记录

## 系统架构

```
┌──────────────────────────────────────────────────────────────────┐
│                         用户界面层                                │
│                 (Web App / 钱包集成 / API)                        │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                      PharosVault 合约                             │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    ERC4626 接口                             │  │
│  │  deposit() | withdraw() | mint() | redeem()                │  │
│  │  convertToShares() | convertToAssets() | previewX()        │  │
│  └────────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    Vault 核心逻辑                           │  │
│  │  策略管理 | 资金分配 | 费用计算 | 紧急控制                   │  │
│  └────────────────────────────────────────────────────────────┘  │
└─────────────────────────────┬────────────────────────────────────┘
                              │
            ┌─────────────────┼─────────────────┐
            │                 │                 │
            ▼                 ▼                 ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│  Strategy A      │ │  Strategy B      │ │  Strategy C      │
│  (RWA 收益)      │ │  (借贷利息)      │ │  (流动性挖矿)    │
└────────┬─────────┘ └────────┬─────────┘ └────────┬─────────┘
         │                    │                    │
         ▼                    ▼                    ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│  外部协议        │ │  外部协议        │ │  外部协议        │
│  (Ondo/Backed)  │ │  (Aave/Compound) │ │  (Uniswap/Curve) │
└──────────────────┘ └──────────────────┘ └──────────────────┘
```

## 核心合约

### PharosVault.sol
- **继承**: ERC4626, Ownable, ReentrancyGuard, Pausable
- **职责**: 
  - 管理用户存取款
  - 协调多个策略
  - 计算和收取费用
  - 处理紧急情况

### BaseStrategy.sol (抽象合约)
- **继承**: IStrategy, Ownable, ReentrancyGuard
- **职责**:
  - 定义策略的通用行为
  - 提供抽象函数供子类实现
  - 管理 Keeper 和权限

### IStrategy.sol (接口)
- 定义策略必须实现的函数
- 确保策略与 Vault 的兼容性

## 数据流

### 存款流程
```
用户 → approve(vault, amount) → deposit(amount, receiver)
                                       │
                                       ▼
                               Vault 铸造份额给用户
                               资产暂存在 Vault 中
                                       │
                                       ▼ (管理员触发)
                    allocateToStrategy(strategy, amount)
                                       │
                                       ▼
                               策略调用 _invest()
                               资产投入外部协议
```

### 收获流程
```
Keeper → harvestStrategy(strategy)
                │
                ▼
        策略调用 _harvest()
        从外部协议收割收益
                │
                ▼
        收益复投或返回 Vault
        更新策略报告
                │
                ▼
        计算绩效费
        更新 Vault 状态
```

### 提现流程
```
用户 → withdraw(assets, receiver, owner)
                │
                ▼
        检查 Vault 空闲资金
                │
        ┌───────┴───────┐
        │               │
        ▼ (足够)        ▼ (不足)
   直接转账      _withdrawFromStrategies()
                        │
                        ▼
                策略调用 _withdraw()
                从外部协议撤回资金
                        │
                        ▼
                   转账给用户
```

## 费用机制

### 管理费 (Management Fee)
- **计算方式**: `totalAssets * managementFee * 时间 / (10000 * 年秒数)`
- **默认费率**: 2% 年化
- **收取时机**: 每次存款/提现时自动计算

### 绩效费 (Performance Fee)
- **计算方式**: `收益 * performanceFee / 10000`
- **默认费率**: 10%
- **收取时机**: 策略 harvest 时计算

### 费用领取
- 累积的费用通过 `claimFees()` 以 Vault 份额形式发放给 `feeRecipient`

## 风险管理

### 策略风险隔离
- 每个策略独立管理其资产
- 单个策略的失败不会影响其他策略
- 可以随时移除表现不佳的策略

### 紧急模式
```solidity
setEmergencyShutdown(true)
    │
    ├─ 暂停所有存款
    │
    └─ 保留提现功能

emergencyWithdrawAll()
    │
    └─ 从所有策略紧急撤回资金
       └─ 资金返回 Vault
          └─ 用户可以正常提现
```

### 存款限额
- 可配置的 `depositLimit` 防止 Vault 规模过大
- 管理员可以根据策略容量调整限额

## 扩展性

### 添加新策略
1. 继承 `BaseStrategy`
2. 实现必要的抽象函数
3. 部署并通过 `addStrategy()` 添加到 Vault

### 多资产支持
- 可以为不同底层资产部署多个 Vault
- 每个 Vault 独立管理其策略

### 升级路径
- 策略可以通过 `removeStrategy()` + `addStrategy()` 升级
- Vault 升级需要迁移资金到新 Vault

## 治理 (未来规划)

### 时间锁
- 关键操作（如费率更改）加入时间锁
- 给用户足够时间退出

### 多签
- 使用多签钱包作为 Owner
- 需要多人签名才能执行管理操作

### DAO 治理
- 发行治理代币
- 重要决策通过投票决定
